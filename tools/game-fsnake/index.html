<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #container {
            border: 1px solid black;
            width: calc(var(--x) * var(--w));
            height: calc(var(--y) * var(--w));
            position: relative;
        }

        fs-snakepart,
        fs-target,
        fs-apple {
            width: var(--w);
            height: var(--w);
            display: block;
            position: absolute;
            pointer-events: none;
        }

        fs-snakepart {
            background-color: hsl(calc(10*var(--index)), 100%, 50%);
            border-radius: var(--w);
            box-shadow: inset 0px 0px 4px 0px black;
            transition: .2s;
            z-index: calc(var(--all) - var(--index));
        }

        fs-target {
            box-shadow: inset 0px 0px 4px 0px black;
        }

        fs-apple {
            border-radius: var(--w);
            background-color: red;
        }
    </style>
    <script>
        (() => {

            HTMLElement.prototype.appendChilds = function (...nodes) { nodes.forEach(node => this.appendChild(node)); }

            class Point {
                static from(pointInstance) {
                    return new Point(pointInstance.x, pointInstance.y);
                }
                x = 0; y = 0;
                constructor(x, y) {
                    this.x = x ?? 0, this.y = y ?? 0;
                }
                equalsTo = (that) => this.x == that.x && this.y == that.y;
            }

            let isGameStarted = false;
            let isMouseControlling = false;

            const GRID_WIDTH = 22;
            const GRID_HEIGHT = 22;
            const GRID_PIXEL_WIDTH = 20; // in px

            const START_POINT = new Point(Math.floor(GRID_WIDTH / 2), Math.floor(GRID_HEIGHT / 2));
            let headPoint = Point.from(START_POINT);
            let applePoint = new Point();
            let snakeSteps = [];
            let snakeParts = [];

            let mousePoint = new Point(); // Mouse Controlling


            /**
             * @type{'L'|'R'|'U'|'D'}
             */
            let direction = 'R';
            /**
             * @type {'H'|'V'}
             */
            let lastMouseStepType = 'H';

            function UpdateNodeCoordinate(node, point) {
                node.style.left = point.x * GRID_PIXEL_WIDTH + 'px';
                node.style.top = point.y * GRID_PIXEL_WIDTH + 'px';
            }

            function UpdateApplePoint() {
                [applePoint.x, applePoint.y] = [Math.floor(Math.random() * GRID_WIDTH), Math.floor(Math.random() * GRID_HEIGHT)];
                for (let movedPoint of snakeSteps) {
                    if (applePoint.equalsTo(movedPoint)) {
                        UpdateApplePoint();
                        return;
                    }
                }
            }

            function UpdateHeadPoint() {
                if (isMouseControlling) {
                    if (lastMouseStepType == 'H') {
                        if (headPoint.x > mousePoint.x) {
                            direction = 'L';
                        } else {
                            direction = 'R';
                        }
                        lastMouseStepType = 'V';
                    } else {
                        if (headPoint.y > mousePoint.y) {
                            direction = 'U';
                        } else {
                            direction = 'D';
                        }
                        lastMouseStepType = 'H';
                    }
                }
                switch (direction) {
                    case 'L':
                        headPoint.x--;
                        if (headPoint.x < 0) {
                            headPoint.x = 0;
                            direction = 'R';
                        }
                        break;
                    case 'R':
                        headPoint.x++;
                        if (headPoint.x >= GRID_WIDTH) {
                            headPoint.x = GRID_WIDTH - 1;
                            direction = 'L';
                        }
                        break;
                    case 'U':
                        headPoint.y--;
                        if (headPoint.y < 0) {
                            headPoint.y = 0;
                            direction = 'D';
                        }
                        break;
                    case 'D':
                        headPoint.y++;
                        if (headPoint.y >= GRID_HEIGHT) {
                            headPoint.y = GRID_HEIGHT - 1;
                            direction = 'U';
                        }
                        break;
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const CONTAINER_NODE = document.getElementById('container');
                let SCORE_NODE = document.getElementById('score');

                CONTAINER_NODE.style.setProperty('--x', GRID_WIDTH);
                CONTAINER_NODE.style.setProperty('--y', GRID_HEIGHT);
                CONTAINER_NODE.style.setProperty('--w', GRID_PIXEL_WIDTH + 'px');

                function startGame() {
                    if (isGameStarted) return;
                    isGameStarted = true;

                    if (isMouseControlling) {
                        CONTAINER_NODE.addEventListener('click', (e) => {
                            mousePoint = new Point(e.layerX / GRID_PIXEL_WIDTH, e.layerY / GRID_PIXEL_WIDTH);
                        })
                    }

                    let appleNode = document.createElement('fs-apple');
                    let targetNode = document.createElement('fs-target');
                    let snakeHeadNode = document.createElement('fs-snakepart');

                    CONTAINER_NODE.appendChilds(appleNode, targetNode, snakeHeadNode);

                    UpdateApplePoint();
                    UpdateNodeCoordinate(appleNode, applePoint);
                    UpdateNodeCoordinate(snakeHeadNode, headPoint);
                    snakeHeadNode.style.setProperty('--index', 0);

                    timer = setInterval(() => {
                        UpdateHeadPoint();
                        UpdateNodeCoordinate(snakeHeadNode, headPoint);
                        UpdateNodeCoordinate(targetNode, headPoint);

                        snakeSteps.unshift(Point.from(headPoint));

                        if (headPoint.equalsTo(applePoint)) {
                            UpdateApplePoint();
                            UpdateNodeCoordinate(appleNode, applePoint);

                            let newPartNode = document.createElement('fs-snakepart');
                            UpdateNodeCoordinate(newPartNode, headPoint);
                            newPartNode.style.setProperty('--index', snakeParts.length - 1);
                            CONTAINER_NODE.appendChild(newPartNode);
                            CONTAINER_NODE.style.setProperty('--all', snakeParts.length);
                            snakeParts.push(newPartNode);

                            SCORE_NODE.textContent = 'Score: ' + snakeParts.length;
                        }

                        snakeParts.forEach((partNode, index) => {
                            UpdateNodeCoordinate(partNode, snakeSteps[index + 1]);
                        });

                        snakeSteps.splice(snakeParts.length, snakeSteps.length);
                    }, 100);
                }

                document.addEventListener('keydown', (e) => { if (e.key.startsWith('Arrow')) direction = e.key[5] })
                document.getElementById('startButton').addEventListener('click', startGame);
                document.getElementById('startMouse').addEventListener('click', () => { isMouseControlling = true; startGame() });
            })
        })();
    </script>
    <title>Document</title>
</head>

<body>
    <header>find FOOD for SNAKE</header>
    <main>
        <div id="container">

        </div>
        <div id="options">
            <button id="startButton">Start</button>
            <button id="startMouse">Start(Mouse)</button>
            <p id="score"></p>
        </div>
    </main>
    <footer></footer>
</body>

</html>